<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Back-and-Forth Chat</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <div class="card">
        <h1>Chat Between <strong>{{ users[0] }}</strong> and <strong>{{ users[1] }}</strong></h1>
        <p style="margin:6px 0 0 0; color:var(--muted); font-size:0.95rem">
          Select a sender & receiver, type a message and press Send.
          Use <em>Clear chat</em> to delete all messages.
        </p>
      </div>
    </header>

    <main class="card">
      <h2 style="margin-top:0; font-size:1.05rem">Conversation</h2>
      <div id="conversation" class="conversation">
        {% if messages|length == 0 %}
          <div style="color:var(--muted); text-align:center; margin-top:40px">
            No messages yet. Start the conversation!
          </div>
        {% endif %}
        {% for msg in messages %}
          {# Check if the message's sender matches the current logged-in user #}
          {% if msg.user == current_user %}
            <div class="message sent">
              <div class="meta">
                {# Sender side doesn't need to show sender/receiver names #}
                <span style="color:var(--muted)">{{ msg.timestamp }}</span>
              </div>
              <div class="text">{{ msg.message }}</div>
            </div>
          {% else %}
            <div class="message received">
              <div class="meta">
                {# Receiver side shows the sender's name #}
                <strong>{{ msg.user }}</strong> Â·
                <span style="color:var(--muted)">{{ msg.timestamp }}</span>
              </div>
              <div class="text">{{ msg.message }}</div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </main>

    <aside class="card aside-card">
      <div class="aside-content">
        <div class="message-form-wrapper">
          <form method="POST" action="{{ url_for('chat_room') }}">



            <div>
              <label for="message">Message</label>
              <textarea id="message" name="message" style="resize: none; height: 100px;"  rows="6" required placeholder="Write a short message..."></textarea>
            </div>
          <div>
              <label for="time">Time</label>
              <textarea id="time" name="time" rows="6" style="resize: none; height: 50px;" required placeholder="Input the response"></textarea>
            </div>


            <div class="actions">
              <div class="left">
                <button class="btn-primary" type="submit">Send</button>
                <button class="btn-danger"
                        type="submit"
                        formmethod="post"
                        formaction="{{ url_for('clear') }}"
                        formnovalidate
                        onclick="return confirm('Delete all messages? This cannot be undone.');">
                  Clear chat
                </button>
              </div>
              <div style="color:var(--muted); font-size:0.85rem">
                Messages: <strong>{{ messages|length }}</strong>
              </div>
            </div>
          </form>
        </div>

        <div class="prediction-result">
          <span style="color:#111827;">Predicted Relationship Duration:</span>
          <span style="color:var(--accent); font-weight: 800; font-size: 1.25rem;">
            {{ predicted_duration }}
          </span>

        </div>
      </div>
    </aside>
  </div>

  <script>
    // Auto-scroll conversation to bottom on load
    (function(){
      var conv = document.getElementById('conversation');
      if(conv){ conv.scrollTop = conv.scrollHeight; }
    })();

    // Prevent selecting same sender/receiver
    (function(){
      // NOTE: This logic is now obsolete as user selection is handled by the Flask session.
    })();
  </script>
</body>
</html>
